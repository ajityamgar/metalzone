{% extends 'base.html' %}
{% block title %}Manage Users - Admin{% endblock %}
{% block content %}

<div class="admin-header">
    <div class="container">
        <h1 style="margin: 0 0 1rem;">User Management</h1>
        <nav class="admin-nav">
            <a href="{{ url_for('admin_dashboard') }}">Dashboard</a>
            <a href="{{ url_for('admin_products') }}">Products</a>
            <a href="{{ url_for('admin_orders') }}">Orders</a>
            <a href="{{ url_for('admin_users') }}" class="active">Users</a>
            <a href="{{ url_for('admin_blog') }}">Blog</a>
            <a href="{{ url_for('admin_coupons') }}">Coupons</a>
            <a href="{{ url_for('admin_reviews') }}">Reviews</a>
            <a href="{{ url_for('admin_messages') }}">Messages</a>
            <a href="{{ url_for('admin_reports') }}">Reports</a>
        </nav>
    </div>
</div>

<section class="section">
    <div class="container">

        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Mobile</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for user in users %}
                <tr>
                    <td><strong>{{ user.name }}</strong></td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.mobile or '-' }}</td>

                    <td>
                        {% if user.is_admin %}
                            <span style="color: var(--header-bg); font-weight: 600;">Admin</span>
                        {% else %}
                            Customer
                        {% endif %}
                    </td>

                    <td>
                        {% if user.blocked %}
                            <span style="color: var(--danger);">Blocked</span>
                        {% else %}
                            <span style="color: var(--success);">Active</span>
                        {% endif %}
                    </td>

                    <td>{{ user.created_at.strftime('%b %d, %Y') }}</td>

                    <td>
                        <form method="POST" action="{{ url_for('admin_users') }}" style="display:inline;">
                            
                            <!-- FIXED CSRF FIELD -->
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <input type="hidden" name="user_id" value="{{ user.id }}">

                            {% if user.email != 'admin@metalzone.com' %}

                                <button type="submit" name="action" value="toggle_admin"
                                    class="btn ghost"
                                    style="padding: 0.4rem 1rem; font-size: 0.85rem;">
                                    {% if user.is_admin %}Remove Admin{% else %}Make Admin{% endif %}
                                </button>

                                <button type="submit" name="action" value="toggle_block"
                                    class="btn ghost"
                                    style="padding: 0.4rem 1rem; font-size: 0.85rem;">
                                    {% if user.blocked %}Unblock{% else %}Block{% endif %}
                                </button>

                                <button type="submit" name="action" value="delete"
                                    class="btn ghost"
                                    style="padding: 0.4rem 1rem; font-size: 0.85rem; color: var(--danger);"
                                    onclick="return confirm('Are you sure you want to delete this user?')">
                                    Delete
                                </button>

                            {% endif %}
                        </form>
                    </td>

                </tr>

                {% else %}
                <tr>
                    <td colspan="7" style="text-align:center; padding:2rem;">
                        No users found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>

    </div>
</section>

{% endblock %}
